{
  "comments":[
    {
      "comment":"I stumbled upon this by chance, investigating https://github.com/microsoft/vscode/issues/84425\r\n\r\n```ts\r\nKeybindingsRegistry.registerKeybindingRule({\r\n\tid: SetEditorLayoutAPICommand.ID,\r\n\targs: { orientation: 0, groups: [{ groups: [{}, {}], size: 0.5 }, { groups: [{}], size: 0.5 }] },\r\n\tweight: 999999,\r\n\twhen: undefined,\r\n\tprimary: KeyMod.CtrlCmd | KeyCode.KEY_P\r\n});\r\n```\r\n\r\n1. `git checkout 47736a99f1c0ea7150e5774f37952bdc6e0fa5d4`\r\n2. Open `apiCommands.ts` and append the snippet above at the end, and automatically add imports\r\n3. Run out of sources\r\n4. Press Ctrl/Cmd+P\r\n5. Close the editor to the right\r\n\r\nElectron will just freeze after printing out the exception to the devtools. Error in terminal:\r\n\r\n```\r\nError: async hook stack has become corrupted (actual: 6316, expected: 0)\r\n```\r\n\r\nCould it be related to https://github.com/microsoft/vscode/issues/83994? cc @roblourens ",
      "user":"joaomoreno"
    },
    {
      "comment":"Thanks for the test case, I am able to repro the issue. This is a different one, `async_hooks` don't work with electron at the moment \r\n\r\nRelevant discussions:\r\nhttps://github.com/electron/electron/pull/12109#pullrequestreview-252043639 \r\nhttps://github.com/electron/electron/pull/18452\r\nhttps://github.com/electron/electron/issues/19466\r\n\r\nYou can workaround this temporarily by setting the following env variable `export NODE_OPTIONS=\"--no-force-async-hooks-checks\"`",
      "user":"deepak1556"
    },
    {
      "comment":"@deepak1556 what does \"workaround\" means in that case? There must be a reason for this to be a hard error, I suspect muting it will just lead to some unexpected execution behaviours. If that's the case - that's not really a valid workaround by any means.",
      "user":"MaxYari"
    },
    {
      "comment":"I don't know if this is useful (or even the same issue), but I got this same error message in a CI run on GitHub actions (seems like a flake, as only one bot failed with it):\r\n\r\n```\r\nError: async hook stack has become corrupted (actual: 1391, expected: 0)\r\n\r\n 1: 0x10e6d1ae4 node::InternalCallbackScope::Close() [/Users/runner/runners/2.262.1/work/Dart-Code/Dart-Code/.vscode-test/vscode-insiders/Visual Studio Code - Insiders.app/Contents/Frameworks/Electron Framework.framework/Versions/A/Electron Framework]\r\n 2: 0x10e6d1999 node::InternalCallbackScope::Close() [/Users/runner/runners/2.262.1/work/Dart-Code/Dart-Code/.vscode-test/vscode-insiders/Visual Studio Code - Insiders.app/Contents/Frameworks/Electron Framework.framework/Versions/A/Electron Framework]\r\n\r\n 3: 0x10e6d1da3 node::InternalCallbackScope::Close() [/Users/runner/runners/2.262.1/work/Dart-Code/Dart-Code/.vscode-test/vscode-insiders/Visual Studio Code - Insiders.app/Contents/Frameworks/Electron Framework.framework/Versions/A/Electron Framework]\r\n\r\n 4: 0x10e6d1fd1 node::MakeCallback(v8::Isolate*, v8::Local<v8::Object>, v8::Local<v8::Function>, int, v8::Local<v8::Value>*, node::async_context) [/Users/runner/runners/2.262.1/work/Dart-Code/Dart-Code/.vscode-test/vscode-insiders/Visual Studio Code - Insiders.app/Contents/Frameworks/Electron Framework.framework/Versions/A/Electron Framework]\r\n\r\n 5: 0x10e7056a5 node::EmitAsyncDestroy(node::Environment*, node::async_context) [/Users/runner/runners/2.262.1/work/Dart-Code/Dart-Code/.vscode-test/vscode-insiders/Visual Studio Code - Insiders.app/Contents/Frameworks/Electron Framework.framework/Versions/A/Electron Framework]\r\n 6: 0x10e8403fd uv_check_stop [/Users/runner/runners/2.262.1/work/Dart-Code/Dart-Code/.vscode-test/vscode-insiders/Visual Studio Code - Insiders.app/Contents/Frameworks/Electron Framework.framework/Versions/A/Electron Framework]\r\n\r\n 7: 0x10e83ab59 uv_run [/Users/runner/runners/2.262.1/work/Dart-Code/Dart-Code/.vscode-test/vscode-insiders/Visual Studio Code - Insiders.app/Contents/Frameworks/Electron Framework.framework/Versions/A/Electron Framework]\r\n\r\n 8: 0x1091a5731 AtomInitializeICUandStartNode [/Users/runner/runners/2.262.1/work/Dart-Code/Dart-Code/.vscode-test/vscode-insiders/Visual Studio Code - Insiders.app/Contents/Frameworks/Electron Framework.framework/Versions/A/Electron Framework]\r\n```\r\n\r\nhttps://github.com/Dart-Code/Dart-Code/runs/692332413#step:15:225",
      "user":"DanTup"
    },
    {
      "comment":"in the main page of Electron, just add bellow environment variable. it will stop the cras.\r\n`process.env[\"NODE_OPTIONS\"] = '--no-force-async-hooks-checks';`",
      "user":"debchy"
    },
    {
      "comment":"I had the Same issue and my application screen went blank and white. Later i discovered it all happened because i was getting an element by id as file in html input which was actually a text. After i commented out that line , my application was working. \r\nI think when the javascript hits any silly bug the electron app crashes and shows that error",
      "user":"yogithecoder"
    },
    {
      "comment":"> in the main page of Electron, just add bellow environment variable. it will stop the cras.\r\n> `process.env[\"NODE_OPTIONS\"] = '--no-force-async-hooks-checks';`\r\n\r\nThis is currently not working for me in line 1 of main file",
      "user":"basiclaser"
    },
    {
      "comment":"> > in the main page of Electron, just add bellow environment variable. it will stop the cras.\r\n> > `process.env[\"NODE_OPTIONS\"] = '--no-force-async-hooks-checks';`\r\n> \r\n> This is currently not working for me in line 1 of main file\r\n\r\nIt was related to an invalid file path for a tray icon:\r\n```\r\nmain.tray = new Tray(\"/invalid/file/path.png\");\r\n```\r\nThe issue was fixed by fixing the file path. Shame the error didn't mention the underlying issue. without `'--no-force-async-hooks-checks'` and fixed path everything is fine.",
      "user":"basiclaser"
    },
    {
      "comment":"> > > in the main page of Electron, just add bellow environment variable. it will stop the cras.\r\n> > > `process.env[\"NODE_OPTIONS\"] = '--no-force-async-hooks-checks';`\r\n> > \r\n> > \r\n> > This is currently not working for me in line 1 of main file\r\n> \r\n> It was related to an invalid file path for a tray icon:\r\n> \r\n> ```\r\n> main.tray = new Tray(\"/invalid/file/path.png\");\r\n> ```\r\n> \r\n> The issue was fixed by fixing the file path. Shame the error didn't mention the underlying issue. without `'--no-force-async-hooks-checks'` and fixed path everything is fine.\r\n\r\nSo, your issue is not related to \"async hook stack\".",
      "user":"debchy"
    },
    {
      "comment":"> > > > in the main page of Electron, just add bellow environment variable. it will stop the cras.\r\n> > > > `process.env[\"NODE_OPTIONS\"] = '--no-force-async-hooks-checks';`\r\n> > > \r\n> > > \r\n> > > This is currently not working for me in line 1 of main file\r\n> > \r\n> > \r\n> > It was related to an invalid file path for a tray icon:\r\n> > ```\r\n> > main.tray = new Tray(\"/invalid/file/path.png\");\r\n> > ```\r\n> > \r\n> > \r\n> >     \r\n> >       \r\n> >     \r\n> > \r\n> >       \r\n> >     \r\n> > \r\n> >     \r\n> >   \r\n> > The issue was fixed by fixing the file path. Shame the error didn't mention the underlying issue. without `'--no-force-async-hooks-checks'` and fixed path everything is fine.\r\n> \r\n> So, your issue is not related to \"async hook stack\".\r\n\r\ni did receive the `Error: async hook stack has become corrupted (actual: 1391, expected: 0)` error, but im not an expert on why :D\r\nI resolved the issue in the way i mentioned though. ",
      "user":"basiclaser"
    }
  ],
  "repository":"vscode",
  "user":"joaomoreno"
}